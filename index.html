<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AGV Simulator - Step0 Compatible (No Module / Safe Init)</title>
<style>
  :root { --brand:#006666; --accent:#ff9900; --panel:#004d4d; --grid:#e6e6e6; }
  * { box-sizing:border-box; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "ヒラギノ角ゴ ProN", "Meiryo", sans-serif; }
  body { margin:0; display:flex; height:100vh; overflow:hidden; }
  .sidebar { width:340px; flex-shrink:0; color:#fff; background:var(--brand); padding:12px 14px; display:flex; flex-direction:column; gap:12px; overflow-y:auto; }
  h1 { font-size:18px; margin:6px 0 8px; font-weight:700; }
  .section { background:var(--panel); border-radius:10px; padding:10px; }
  .row { display:flex; align-items:center; gap:8px; margin:6px 0; }
  .btn { cursor:pointer; border:none; border-radius:8px; padding:8px 10px; font-weight:700; }
  .btn.primary { background:#fff; color:var(--brand); }
  .btn.ghost { background:transparent; border:1px solid #fff; color:#fff; }
  .note { font-size:12px; opacity:.9; }
  .status { background:#003d3d; padding:8px; border-radius:8px; font-size:13px; line-height:1.4; }
  canvas { flex:1; display:block; background:#fff; min-width:260px; }
  .toast { position:fixed; left:50%; top:18px; transform:translateX(-50%); background:#333; color:#fff; padding:8px 12px; border-radius:8px; font-size:13px; opacity:0; transition:opacity .2s ease; pointer-events:none; z-index:9; }
  .toast.show { opacity:.95; }
  .banner { position:fixed; left:0; right:0; top:0; padding:8px 12px; background:#c62828; color:#fff; font-weight:700; display:none; z-index:10; }
  .dev { font-size:12px; background:#002c2c; color:#cde; padding:8px; border-radius:8px; white-space:pre-wrap; word-break:break-word; }
</style>
</head>
<body>
  <aside class="sidebar">
    <h1>AGV ルート作成（Step0）</h1>

    <div class="section">
      <div class="row"><strong>操作手順</strong></div>
      <ol class="note" style="margin:6px 0 0 18px;">
        <li>ルート生成を <b>ON</b> にする</li>
        <li>キャンバスの <b>交点</b> をクリックしてポイント追加（<b>水平・垂直のみ</b>）</li>
        <li>スタート/ゴールは <b>交点をダブルクリック</b>（S→G→S→G…）</li>
        <li>やり直しは「最後のポイント削除」または「全消去」</li>
      </ol>
    </div>

    <div class="section">
      <div class="row">
        <label>ルート生成</label>
        <button id="toggleBuild" class="btn primary">ON</button>
      </div>
      <div class="row">
        <button id="undo" class="btn ghost">最後のポイント削除</button>
        <button id="clear" class="btn ghost">全消去</button>
      </div>
      <div class="note">グリッドは <b>1m/マス</b>（表示は40px/マス）</div>
    </div>

    <div class="section status">
      追加ポイント: <span id="ptCount">0</span> 個<br/>
      スタート: <span id="sPos">-</span><br/>
      ゴール: <span id="gPos">-</span>
    </div>

    <div class="section dev" id="devLog">[dev log]</div>
  </aside>

  <canvas id="map"></canvas>
  <div id="toast" class="toast"></div>
  <div id="banner" class="banner"></div>

<!-- 互換性重視：type="module"は使わず、スクリプトはボディ末尾＆deferで実行順を保証 -->
<script defer>
(function(){
  // ===== 基本設定 =====
  var PX_PER_M = 40;  // 表示1マス=40px（論理1m）
  var GRID = PX_PER_M;
  // 状態（varで巻き上げの挙動に依存しない・TDZなし）
  var canvas, ctx, building, points, start, goal, toastEl, devLog;
  building = true;
  points = []; start = null; goal = null;

  function log(msg){ try{ devLog.textContent = (devLog.textContent+"\n"+msg).slice(-2000); }catch(e){} console.log(msg); }
  function banner(msg){ var b=document.getElementById('banner'); b.textContent=msg; b.style.display='block'; }

  function ready(){
    canvas = document.getElementById('map') || document.getElementById('mapCanvas');
    toastEl = document.getElementById('toast');
    devLog = document.getElementById('devLog');
    if(!canvas){ banner('Canvasが見つかりません（id="map" または "mapCanvas"）'); return; }
    ctx = canvas.getContext('2d');

    // UI参照
    var toggleBtn = document.getElementById('toggleBuild');
    var undoBtn   = document.getElementById('undo');
    var clearBtn  = document.getElementById('clear');

    // ハンドラ
    toggleBtn.addEventListener('click', function(){ building=!building; toggleBtn.textContent = building? 'ON':'OFF'; canvas.style.cursor = building? 'crosshair':'default'; drawAll(); });
    undoBtn.addEventListener('click', function(){ points.pop(); drawAll(); });
    clearBtn.addEventListener('click', function(){ points.length=0; start=null; goal=null; drawAll(); });

    window.addEventListener('resize', resize);
    canvas.addEventListener('click', onClick, {passive:true});
    canvas.addEventListener('dblclick', onDblClick, {passive:false});
    window.addEventListener('keydown', onKey);

    resize();
    drawAll();
    log('init ok: '+navigator.userAgent);
  }

  function resize(){
    var sidebar = document.querySelector('.sidebar');
    var sw = sidebar ? sidebar.offsetWidth : 340;
    var w = Math.max(260, window.innerWidth - sw);
    canvas.width = w;
    canvas.height = window.innerHeight;
  }

  function snapToGrid(clientX, clientY){
    var r = canvas.getBoundingClientRect();
    var x = Math.round((clientX - r.left)/GRID)*GRID;
    var y = Math.round((clientY - r.top) /GRID)*GRID;
    return [x,y];
  }
  function toast(msg){ if(!toastEl) return; toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(function(){toastEl.classList.remove('show');}, 900); }
  function status(){
    document.getElementById('ptCount').textContent = String(points.length);
    document.getElementById('sPos').textContent = start? '('+(start[0]/GRID)+'m, '+(start[1]/GRID)+'m)': '-';
    document.getElementById('gPos').textContent = goal ? '('+(goal[0]/GRID)+'m, '+(goal[1]/GRID)+'m)': '-';
  }

  function drawGrid(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle = '#e6e6e6'; ctx.lineWidth = 1;
    for(var x=0; x<=canvas.width; x+=GRID){ ctx.beginPath(); ctx.moveTo(x+.5,0); ctx.lineTo(x+.5,canvas.height); ctx.stroke(); }
    for(var y=0; y<=canvas.height; y+=GRID){ ctx.beginPath(); ctx.moveTo(0,y+.5); ctx.lineTo(canvas.width,y+.5); ctx.stroke(); }
  }
  function drawSegments(){
    if(points.length<2) return; ctx.lineWidth=2; ctx.strokeStyle = building? '#ff9900':'#0066cc';
    for(var i=0;i<points.length-1;i++){
      var p1=points[i], p2=points[i+1];
      if(p1[0]!==p2[0] && p1[1]!==p2[1]){ toast('斜めは不可'); continue; }
      ctx.beginPath(); ctx.moveTo(p1[0],p1[1]); ctx.lineTo(p2[0],p2[1]); ctx.stroke();
    }
  }
  function drawPoints(){
    for(var i=0;i<points.length;i++){
      var p=points[i]; ctx.fillStyle='#22aa22'; ctx.beginPath(); ctx.arc(p[0],p[1],4,0,Math.PI*2); ctx.fill();
    }
    ctx.fillStyle='#000'; ctx.font='bold 16px system-ui, sans-serif';
    if(start) ctx.fillText('S', start[0]-5, start[1]-8);
    if(goal)  ctx.fillText('G', goal[0]-5,  goal[1]-8);
  }
  function drawAll(){ drawGrid(); drawSegments(); drawPoints(); status(); }

  function onClick(e){
    if(!building) return; var xy=snapToGrid(e.clientX,e.clientY);
    if(points.length>0){ var last=points[points.length-1]; if(last[0]!==xy[0] && last[1]!==xy[1]){ toast('斜めは不可'); return; } }
    points.push(xy); drawAll();
  }
  function onDblClick(e){ e.preventDefault(); var xy=snapToGrid(e.clientX,e.clientY); if(!start || (start && goal)){ start=xy; goal=null; } else { goal=xy; } drawAll(); }
  function onKey(e){ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){ points.pop(); drawAll(); } }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', ready);
  }else{ ready(); }
})();
</script>
</body>
</html>
