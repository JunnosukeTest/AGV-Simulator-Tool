<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AGV Simulator Step3 - モックUI</title>
<style>
body {margin:0; display:flex; height:100vh; font-family:sans-serif;}
.sidebar {width:360px; background:#006666; color:white; padding:1em; display:flex; flex-direction:column; gap:1em; overflow-y:auto;}
.sidebar h2 {font-size:1.2em; border-bottom:1px solid #fff; padding-bottom:0.3em; margin-top:1em;}
.sidebar label {display:flex; justify-content:space-between; align-items:center; margin:0.2em 0;}
.sidebar input, .sidebar select {width:100px;}
button {margin-top:0.5em; cursor:pointer;}
.route-block {background:#004d4d; padding:0.5em; border-radius:5px; margin-bottom:0.5em;}
.route-block span {margin-right:0.5em;}
.agv-modal {display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:white; color:black; padding:1em; border:2px solid #006666; border-radius:8px; z-index:1000;}
.agv-modal h3 {margin-top:0;}
.modal-backdrop {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index:999;}
canvas {flex:1; background:#fff; display:block; cursor:grab;}
.sim-section {margin-top: 1em; background:#004d4d; padding:0.5em; border-radius:5px;}
.sim-section h3 {margin:0.5em 0; font-size:1em; border-bottom:1px solid #fff;}
.sim-section label {display:flex; justify-content:space-between; margin:0.2em 0;}
.result-block {margin-top: 1em; background:#003333; padding:0.5em; border-radius:5px; font-size:0.9em;}
</style>
</head>
<body>
<div class="sidebar">
  <h2>要件定義</h2>
  <div id="routes"></div>
  <div>
    <button onclick="addRoute()">＋</button>
    <button onclick="removeRoute()">−</button>
  </div>

  <div class="sim-section">
    <h3>AGV運行パラメータ</h3>
    <label>速度(m/s)：<input type="number" value="0.5"></label>
    <label>積載量(kg)：<input type="number" value="500"></label>
    <label>充電係数(%)：<input type="number" value="70"></label>
    <label>旋回速度(s)：<input type="number" value="2"></label>
    <label>旋回回数：<input type="number" value="0"></label>
    <label>待機時間(S)：<input type="number" value="2"></label>
    <label>待機時間(G)：<input type="number" value="2"></label>
    <button>シュミレーション開始</button>
  </div>

  <div class="result-block">
    <h3>シュミレーション結果</h3>
    <p>搬送回数：____</p>
    <p>必要台数：____</p>
  </div>
</div>
<canvas id="mapCanvas"></canvas>

<!-- モーダルウィンドウ -->
<div class="modal-backdrop" id="modalBackdrop"></div>
<div class="agv-modal" id="agvModal">
  <h3>AGV選択</h3>
  <div id="agvOptions"></div>
  <button onclick="confirmAGVSelection()">OK</button>
</div>

<script>
const canvas = document.getElementById("mapCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth - 360;
canvas.height = window.innerHeight;
let scale = 1;
let offsetX = 0, offsetY = 0;
const gridSize = 50;
const markers = [];

function drawGrid() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = '#ddd';
  ctx.beginPath();
  for (let x = offsetX % gridSize; x < canvas.width; x += gridSize) {
    ctx.moveTo(x, 0);
    ctx.lineTo(x, canvas.height);
  }
  for (let y = offsetY % gridSize; y < canvas.height; y += gridSize) {
    ctx.moveTo(0, y);
    ctx.lineTo(canvas.width, y);
  }
  ctx.stroke();

  markers.forEach(p => {
    ctx.fillStyle = 'black';
    ctx.font = "bold 16px sans-serif";
    ctx.fillText(p.label, p.x - 6, p.y + 6);
  });
}

drawGrid();

canvas.addEventListener("dblclick", (e) => {
  const rect = canvas.getBoundingClientRect();
  const x = Math.round((e.clientX - rect.left - offsetX) / gridSize) * gridSize + offsetX;
  const y = Math.round((e.clientY - rect.top - offsetY) / gridSize) * gridSize + offsetY;
  const nextLabel = (markers.length % 2 === 0) ? "S" : "G";
  markers.push({ x, y, label: nextLabel });
  drawGrid();
});

let routeIndex = 1;
function addRoute() {
  const routesDiv = document.getElementById("routes");
  const div = document.createElement("div");
  div.className = "route-block";
  div.innerHTML = `<span>ルート${routeIndex}</span><span>AGV: -</span><button onclick="toggleRoute(${routeIndex})">経路生成 OFF</button>`;
  routesDiv.appendChild(div);
  routeIndex++;
}

function removeRoute() {
  const routesDiv = document.getElementById("routes");
  if (routesDiv.lastChild) {
    routesDiv.removeChild(routesDiv.lastChild);
    routeIndex = Math.max(1, routeIndex - 1);
  }
}

function toggleRoute(index) {
  alert(`ルート${index}の経路生成を切替えます（実装予定）`);
}
</script>
</body>
</html>
