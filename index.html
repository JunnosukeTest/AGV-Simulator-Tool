<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AGV Simulator Step2 完成版</title>
<style>
body {margin:0; display:flex; height:100vh; font-family:sans-serif;}
.sidebar {width:320px; background:#006666; color:white; padding:1em; display:flex; flex-direction:column; gap:1em;}
.sidebar h2 {font-size:1.2em; border-bottom:1px solid #fff; padding-bottom:0.5em;}
.sidebar label {display:flex; justify-content:space-between; align-items:center; margin:0.2em 0;}
.sidebar input {width:80px;}
.result,.capacity {background:#004d4d; padding:0.5em; border-radius:5px; font-size:0.9em;}
.accent {color:#FF9900; font-weight:bold;}
canvas {flex:1; background:#fff; display:block; cursor:grab;}
</style>
</head>
<body>
<div class="sidebar">
  <h2>AGV運行パラメータ入力</h2>
  <label>速度(m/s): <input type="number" id="speed" value="0.5" step="0.1"></label>
  <label>台車間隔(m): <input type="number" id="spacing" value="3"></label>
  <label>グリッド間隔(m): <input type="number" id="gridSizeInput" value="1" step="0.1" min="0.1" max="10"></label>
  <button id="resetBtn">全リセット</button>
  <div class="result" id="result">距離・時間計算結果</div>
  <div class="capacity" id="capacity">必要台数計算結果</div>
</div>
<canvas id="mapCanvas"></canvas>
<script>
const canvas=document.getElementById('mapCanvas');
const ctx=canvas.getContext('2d');
let scale=1, offsetX=0, offsetY=0, isDragging=false, dragStart={x:0,y:0};
let points=[], lines=[];
let gridSizeM=1;
function resizeCanvas(){canvas.width=window.innerWidth-320;canvas.height=window.innerHeight;draw();}
window.addEventListener('resize',resizeCanvas);resizeCanvas();
function draw(){const gs=gridSizeM*100*scale;ctx.clearRect(0,0,canvas.width,canvas.height);ctx.strokeStyle='#ddd';ctx.beginPath();for(let x=offsetX%gs;x<canvas.width;x+=gs){ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);}for(let y=offsetY%gs;y<canvas.height;y+=gs){ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);}ctx.stroke();lines.forEach(l=>{ctx.strokeStyle='blue';ctx.beginPath();ctx.moveTo(l[0].x,l[0].y);ctx.lineTo(l[1].x,l[1].y);ctx.stroke();});points.forEach(p=>{ctx.fillStyle='green';ctx.beginPath();ctx.arc(p.x,p.y,5,0,Math.PI*2);ctx.fill();});}
canvas.addEventListener('mousedown',e=>{isDragging=true;dragStart.x=e.clientX;dragStart.y=e.clientY;canvas.style.cursor='grabbing';});
canvas.addEventListener('mouseup',()=>{isDragging=false;canvas.style.cursor='grab';});
canvas.addEventListener('mousemove',e=>{if(isDragging){offsetX+=e.clientX-dragStart.x;offsetY+=e.clientY-dragStart.y;dragStart.x=e.clientX;dragStart.y=e.clientY;draw();}});
canvas.addEventListener('wheel',e=>{e.preventDefault();const f=1.05;if(e.deltaY<0&&scale<5){scale*=f;}else if(e.deltaY>0&&scale>0.1){scale/=f;}draw();});
canvas.addEventListener('click',e=>{const rect=canvas.getBoundingClientRect();const gs=gridSizeM*100*scale;const x=Math.round((e.clientX-rect.left-offsetX)/gs)*gs+offsetX;const y=Math.round((e.clientY-rect.top-offsetY)/gs)*gs+offsetY;const point={x,y};points.push(point);if(points.length>1){lines.push([points[points.length-2],point]);}
draw();});
canvas.addEventListener('contextmenu',e=>{e.preventDefault();const rect=canvas.getBoundingClientRect();const mx=e.clientX-rect.left;const my=e.clientY-rect.top;for(let i=0;i<lines.length;i++){const l=lines[i];const d=distancePointToLine({x:mx,y:my},l[0],l[1]);if(d<10){lines.splice(i,1);draw();return;}}});
function distancePointToLine(p,a,b){const t=((p.x-a.x)*(b.x-a.x)+(p.y-a.y)*(b.y-a.y))/((b.x-a.x)**2+(b.y-a.y)**2);const tClamp=Math.max(0,Math.min(1,t));const proj={x:a.x+tClamp*(b.x-a.x),y:a.y+tClamp*(b.y-a.y)};return Math.hypot(p.x-proj.x,p.y-proj.y);}
document.getElementById('resetBtn').addEventListener('click',()=>{points=[];lines=[];document.getElementById('result').innerText='距離・時間計算結果';document.getElementById('capacity').innerText='必要台数計算結果';draw();});
document.getElementById('gridSizeInput').addEventListener('change',e=>{let v=parseFloat(e.target.value);if(v<0.1)v=0.1;if(v>10)v=10;gridSizeM=Math.round(v*10)/10;draw();});
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='z'){if(points.length>0){points.pop();lines.pop();draw();}}});
</script>
</body>
</html>
