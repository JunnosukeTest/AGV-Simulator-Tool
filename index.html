<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AGV Simulator Step3 - モックUI</title>
<style>
body {margin:0; display:flex; height:100vh; font-family:sans-serif; overflow:hidden;}
.sidebar {flex-shrink: 0; width: 340px; background:#006666; color:white; padding:1em; display:flex; flex-direction:column; gap:1em; overflow-y:auto; box-sizing: border-box;}
.sidebar h2 {font-size:1.2em; border-bottom:1px solid #fff; padding-bottom:0.3em; margin-top:1em;}
.sidebar label {display:flex; justify-content:space-between; align-items:center; margin:0.2em 0; gap: 0.5em; padding-left: 0.5em; padding-right: 0.5em;}
.sidebar input, .sidebar select {width: 120px;}
button {margin-top:0.5em; cursor:pointer;}
.route-block {background:#004d4d; padding:0.5em; border-radius:5px; margin-bottom:0.5em;}
.route-block span {margin-right:0.5em;}
.route-block .status-btn {margin-left: 0.5em;}
canvas {flex-grow:1; background:#fff; display:block; cursor:grab;}
.sim-section {margin-top: 1em; background:#004d4d; padding:0.5em; border-radius:5px;}
.sim-section h3 {margin:0.5em 0; font-size:1em; border-bottom:1px solid #fff;}
.sim-section label {display:flex; justify-content:space-between; margin:0.2em 0; gap: 0.5em; padding-left: 0.5em; padding-right: 0.5em;}
.result-block {margin-top: 1em; background:#003333; padding:0.5em; border-radius:5px; font-size:0.9em; color: #fff;}
</style>
</head>
<body>
<div class="sidebar">
  <h2>要件定義</h2>
  <div id="routes"></div>
  <div>
    <button onclick="addRoute()">＋</button>
    <button onclick="removeRoute()">−</button>
  </div>

  <div class="sim-section">
    <h3>AGV運行パラメータ</h3>
    <label>速度(m/s)：<input type="number" id="speed" value="0.5"></label>
    <label>積載量(kg)：<input type="number" id="load" value="500"></label>
    <label>充電係数(%)：<input type="number" id="charge" value="70"></label>
    <label>旋回速度(s)：<input type="number" id="turn" value="2"></label>
    <label>旋回回数：<input type="number" id="turns" value="0"></label>
    <label>待機時間(S)：<input type="number" id="waitS" value="2"></label>
    <label>待機時間(G)：<input type="number" id="waitG" value="2"></label>
    <button onclick="startSimulation()">シュミレーション開始</button>
  </div>

  <div class="result-block">
    <h3>シュミレーション結果</h3>
    <p id="result-count">搬送回数：____</p>
    <p id="result-vehicles">必要台数：____</p>
  </div>
</div>
<canvas id="mapCanvas"></canvas>

<script>
const canvas = document.getElementById("mapCanvas");
const ctx = canvas.getContext("2d");
let scale = 1;
let offsetX = 0, offsetY = 0;
const gridSize = 50;
const markers = [];
let activeRoute = null;

function resizeCanvas() {
  const sidebarWidth = document.querySelector('.sidebar').offsetWidth;
  canvas.width = window.innerWidth - sidebarWidth;
  canvas.height = window.innerHeight;
  drawGrid();
}

window.addEventListener("resize", resizeCanvas);
window.addEventListener("load", resizeCanvas);

function drawGrid() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = '#ddd';
  ctx.beginPath();
  for (let x = offsetX % gridSize; x < canvas.width; x += gridSize) {
    ctx.moveTo(x, 0);
    ctx.lineTo(x, canvas.height);
  }
  for (let y = offsetY % gridSize; y < canvas.height; y += gridSize) {
    ctx.moveTo(0, y);
    ctx.lineTo(canvas.width, y);
  }
  ctx.stroke();

  markers.forEach(p => {
    ctx.fillStyle = 'black';
    ctx.font = "bold 16px sans-serif";
    ctx.fillText(p.label, p.x - 6, p.y + 6);
  });
}

canvas.addEventListener("dblclick", (e) => {
  if (activeRoute === null) return;
  const rect = canvas.getBoundingClientRect();
  const x = Math.round((e.clientX - rect.left - offsetX) / gridSize) * gridSize + offsetX;
  const y = Math.round((e.clientY - rect.top - offsetY) / gridSize) * gridSize + offsetY;
  const nextLabel = (markers.length % 2 === 0) ? "S" : "G";
  markers.push({ x, y, label: nextLabel });
  drawGrid();
});

let routeIndex = 1;
function addRoute() {
  const routesDiv = document.getElementById("routes");
  const div = document.createElement("div");
  div.className = "route-block";
  div.innerHTML = `<span>ルート${routeIndex}</span><span>AGV: <select><option>A</option><option>B</option><option>C</option><option>D</option><option>E</option><option>F</option><option>G</option><option>H</option><option>I</option><option>J</option></select></span><button class='status-btn' onclick="toggleRoute(${routeIndex})">経路生成 OFF</button>`;
  routesDiv.appendChild(div);
  routeIndex++;
}

function removeRoute() {
  const routesDiv = document.getElementById("routes");
  if (routesDiv.lastChild) {
    routesDiv.removeChild(routesDiv.lastChild);
    routeIndex = Math.max(1, routeIndex - 1);
  }
}

function toggleRoute(index) {
  const buttons = document.querySelectorAll('.status-btn');
  buttons.forEach(btn => btn.innerText = '経路生成 OFF');
  activeRoute = (activeRoute === index) ? null : index;
  if (activeRoute) {
    buttons[index - 1].innerText = '経路生成 ON';
  }
}

function startSimulation() {
  const speed = parseFloat(document.getElementById("speed").value);
  const load = parseFloat(document.getElementById("load").value);
  const charge = parseFloat(document.getElementById("charge").value);
  const turn = parseFloat(document.getElementById("turn").value);
  const turns = parseFloat(document.getElementById("turns").value);
  const waitS = parseFloat(document.getElementById("waitS").value);
  const waitG = parseFloat(document.getElementById("waitG").value);
  const totalTime = (markers.length - 1) * (turn + waitS + waitG) / 2;
  const vehicleCount = Math.ceil((load / 100) * (100 / charge));
  document.getElementById("result-count").innerText = `搬送回数：${Math.round(totalTime)}`;
  document.getElementById("result-vehicles").innerText = `必要台数：${vehicleCount}`;
}

window.onload = () => {
  addRoute();
};
</script>
</body>
</html>
