<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AGV Simulator Step3 - モックUI</title>
<style>
body {margin:0; display:flex; height:100vh; font-family:sans-serif;}
.sidebar {width:360px; background:#006666; color:white; padding:1em; display:flex; flex-direction:column; gap:1em; overflow-y:auto;}
.sidebar h2 {font-size:1.2em; border-bottom:1px solid #fff; padding-bottom:0.3em; margin-top:1em;}
.sidebar label {display:flex; justify-content:space-between; align-items:center; margin:0.2em 0;}
.sidebar input, .sidebar select {width:100px;}
button {margin-top:0.5em; cursor:pointer;}
.route-block {background:#004d4d; padding:0.5em; border-radius:5px; margin-bottom:0.5em;}
.route-block span {margin-right:0.5em;}
.agv-modal {display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:white; color:black; padding:1em; border:2px solid #006666; border-radius:8px; z-index:1000;}
.agv-modal h3 {margin-top:0;}
.modal-backdrop {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index:999;}
canvas {flex:1; background:#fff; display:block; cursor:grab;}
</style>
</head>
<body>
<div class="sidebar">
  <h2>要件定義</h2>
  <div id="routes"></div>
  <div>
    <button onclick="addRoute()">＋</button>
    <button onclick="removeRoute()">−</button>
  </div>
</div>
<canvas id="mapCanvas"></canvas>

<!-- モーダルウィンドウ -->
<div class="modal-backdrop" id="modalBackdrop"></div>
<div class="agv-modal" id="agvModal">
  <h3>AGV選択</h3>
  <div id="agvOptions"></div>
  <button onclick="confirmAGVSelection()">OK</button>
</div>

<script>
let routeCount = 0;
const routesDiv = document.getElementById('routes');
const modal = document.getElementById('agvModal');
const backdrop = document.getElementById('modalBackdrop');
let currentRouteId = null;
const selectedAGVs = {};
const routeData = {};

const canvas = document.getElementById('mapCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth - 360;
canvas.height = window.innerHeight;
let scale = 1;
let offsetX = 0, offsetY = 0;
const gridSize = 50; // グリッドの大きさ(px)

function drawGrid() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = '#ddd';
  ctx.beginPath();
  for (let x = offsetX % gridSize; x < canvas.width; x += gridSize) {
    ctx.moveTo(x, 0);
    ctx.lineTo(x, canvas.height);
  }
  for (let y = offsetY % gridSize; y < canvas.height; y += gridSize) {
    ctx.moveTo(0, y);
    ctx.lineTo(canvas.width, y);
  }
  ctx.stroke();

  // 現在アクティブなルートのポイントと線を描画
  for (const routeId in routeData) {
    const { points, active } = routeData[routeId];
    ctx.strokeStyle = active ? 'blue' : 'gray';
    for (let i = 1; i < points.length; i++) {
      const dx = Math.abs(points[i].x - points[i - 1].x);
      const dy = Math.abs(points[i].y - points[i - 1].y);
      if (dx === 0 || dy === 0) {
        ctx.beginPath();
        ctx.moveTo(points[i - 1].x, points[i - 1].y);
        ctx.lineTo(points[i].x, points[i].y);
        ctx.stroke();
      }
    }
    points.forEach(p => {
      ctx.fillStyle = 'green';
      ctx.beginPath();
      ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
      ctx.fill();
    });
  }
}

drawGrid();

canvas.addEventListener('click', (e) => {
  const rect = canvas.getBoundingClientRect();
  const x = Math.round((e.clientX - rect.left - offsetX) / gridSize) * gridSize + offsetX;
  const y = Math.round((e.clientY - rect.top - offsetY) / gridSize) * gridSize + offsetY;
  for (const routeId in routeData) {
    if (routeData[routeId].active) {
      const pts = routeData[routeId].points;
      if (!routeData[routeId].paused) {
        pts.push({ x, y });
      } else {
        routeData[routeId].paused = false;
      }
    }
  }
  drawGrid();
});

function addRoute() {
  if(routeCount >= 10) return;
  routeCount++;
  const div = document.createElement('div');
  div.className = 'route-block';
  div.id = `route${routeCount}`;
  div.innerHTML = `
    <span><strong>ルート${routeCount}</strong></span>
    <button onclick="openAGVModal(${routeCount})">AGV選択</button>
    <button onclick="togglePath(${routeCount}, this)">経路生成 OFF</button>
    <span id="agvDisplay${routeCount}"></span>
  `;
  routesDiv.appendChild(div);
  selectedAGVs[routeCount] = [];
  routeData[routeCount] = { points: [], active: false, paused: false };
  drawGrid();
}

function removeRoute() {
  if(routeCount === 0) return;
  const lastRoute = document.getElementById(`route${routeCount}`);
  if (lastRoute) {
    routesDiv.removeChild(lastRoute);
    delete selectedAGVs[routeCount];
    delete routeData[routeCount];
    routeCount--;
    drawGrid();
  }
}

function openAGVModal(routeId) {
  currentRouteId = routeId;
  document.getElementById('agvOptions').innerHTML = '';
  for(let i=0; i<10; i++) {
    const agv = String.fromCharCode(65+i);
    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.value = agv;
    chk.id = `chk${agv}`;
    chk.checked = selectedAGVs[routeId].includes(agv);
    const label = document.createElement('label');
    label.htmlFor = `chk${agv}`;
    label.innerText = agv;
    document.getElementById('agvOptions').appendChild(chk);
    document.getElementById('agvOptions').appendChild(label);
    document.getElementById('agvOptions').appendChild(document.createElement('br'));
  }
  modal.style.display = 'block';
  backdrop.style.display = 'block';
}

function confirmAGVSelection() {
  const selected = [];
  for(let i=0; i<10; i++) {
    const agv = String.fromCharCode(65+i);
    const chk = document.getElementById(`chk${agv}`);
    if(chk.checked) selected.push(agv);
  }
  selectedAGVs[currentRouteId] = selected;
  document.getElementById(`agvDisplay${currentRouteId}`).innerText = ` [${selected.join(',')}]`;
  modal.style.display = 'none';
  backdrop.style.display = 'none';
}

function togglePath(routeId, btn) {
  if (!routeData[routeId]) return;
  if(btn.innerText.includes('OFF')) {
    btn.innerText = '経路生成 ON';
    routeData[routeId].active = true;
    routeData[routeId].paused = false;
  } else {
    btn.innerText = '経路生成 OFF';
    routeData[routeId].active = false;
    routeData[routeId].paused = true;
  }
  drawGrid();
}
</script>
</body>
</html>
